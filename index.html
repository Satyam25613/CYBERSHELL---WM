<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER SHELL - AI Digital Safety Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A simple fade-in animation for the result card */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }

        /* A simple spin animation for the loader icon */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow { animation: spin 1.5s linear infinite; }

        /* Style for invalid input fields */
        .input-error {
            border-color: #ef4444 !important; /* red-500 */
            --tw-ring-color: #ef4444 !important; /* red-500 */
        }
        
        /* Custom styles for the result card colors */
        .border-red-500 { border-color: #ef4444; }
        .border-green-500 { border-color: #10b981; }
        .border-yellow-500 { border-color: #f59e0b; }
        .bg-red-50 { background-color: #fef2f2; }
        .bg-green-50 { background-color: #ecfdf5; }
        .bg-yellow-50 { background-color: #fffbeb; }

        /* Custom style for source text area (to make AI text readable) */
        .prose { 
            max-width: 100%; 
            color: #1f2937; /* gray-800 */
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">

    <header class="bg-white shadow-sm sticky top-0 z-50 backdrop-blur-md bg-opacity-80">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-center sm:justify-between items-center">
            <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <h1 class="text-2xl font-bold text-gray-800">CYBER SHELL</h1>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
            <div class="w-full max-w-2xl mx-auto">
                <div id="verifier-tabs" class="flex justify-center space-x-2 sm:space-x-4 rounded-full bg-gray-100 p-2">
                    <button data-verifier="news" class="verifier-tab flex-1 px-3 py-2 text-sm sm:text-base font-semibold rounded-full transition-colors duration-300 flex items-center justify-center space-x-2 bg-blue-600 text-white shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 20h-4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2H0v-2a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v2zm0-4H0V4a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12zM5 8h2m-2 4h2m-2 4h2"/></svg>
                        <span class="hidden sm:inline">News</span>
                    </button>
                    <button data-verifier="link" class="verifier-tab flex-1 px-3 py-2 text-sm sm:text-base font-semibold rounded-full transition-colors duration-300 flex items-center justify-center space-x-2 text-gray-600 hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7-7l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>
                        <span class="hidden sm:inline">Link</span>
                    </button>
                    <button data-verifier="number" class="verifier-tab flex-1 px-3 py-2 text-sm sm:text-base font-semibold rounded-full transition-colors duration-300 flex items-center justify-center space-x-2 text-gray-600 hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                        <span class="hidden sm:inline">Number</span>
                    </button>
                </div>
                
                <div class="mt-8 text-center">
                    <h2 id="verifier-title" class="text-2xl font-bold text-gray-800">Fake News Verifier</h2>
                    <p class="text-gray-600 mt-2">Get instant analysis to stay safe.</p>
                </div>

                <form id="verifier-form" class="mt-6">
                    <div class="relative">
                        <input id="verifier-input" type="text" placeholder="Enter a news headline or claim..." class="w-full px-4 py-3 pr-24 sm:pr-28 rounded-full border-2 border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" />
                        <button id="verify-button" type="submit" class="absolute right-1.5 top-1.5 px-4 sm:px-6 py-2 rounded-full bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors duration-300 flex items-center">
                            Verify
                        </button>
                    </div>
                </form>
                <p id="error-message" class="text-red-500 text-sm mt-2 text-center h-4"></p>


                <div id="loader" class="text-center mt-6 justify-center items-center text-gray-600 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin-slow h-5 w-5 mr-2 inline-block"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                    Checking...
                </div>

                <div id="result-container"></div>
            </div>
        </div>
        
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <div class="space-y-12">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Before a Scam (Prevention Tips)</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-green-500 mt-1 flex-shrink-0"><polyline points="9 18 15 12 9 6"></polyline></svg><span class="ml-2 text-gray-700">Verify news from **multiple trusted sources** before sharing.</span></li>
                        <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-green-500 mt-1 flex-shrink-0"><polyline points="9 18 15 12 9 6"></polyline></svg><span class="ml-2 text-gray-700">Never click on links from **unknown or suspicious senders**.</span></li>
                        <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-green-500 mt-1 flex-shrink-0"><polyline points="9 18 15 12 9 6"></polyline></svg><span class="ml-2 text-gray-700">Enable **Two-Factor Authentication (2FA)** on all your accounts.</span></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">After a Scam (Action Steps)</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-red-500 mt-1 flex-shrink-0"><polyline points="9 18 15 12 9 6"></polyline></svg><span class="ml-2 text-gray-700">Immediately **block the number/sender** and report it on the platform.</span></li>
                        <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-red-500 mt-1 flex-shrink-0"><polyline points="9 18 15 12 9 6"></polyline></svg><span class="ml-2 text-gray-700">**Contact your bank** immediately if you've shared financial details.</span></li>
                        <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-red-500 mt-1 flex-shrink-0"><polyline points="9 18 15 12 9 6"></polyline></svg><span class="ml-2 text-gray-700">Report the incident to the appropriate **cyber crime portal** (e.g., cybercrime.gov.in).</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center py-6 text-sm text-gray-500">
        <p>&copy; 2025 CYBER SHELL. All Rights Reserved.</p>
        <p class="mt-1">Your AI-Powered Digital Guardian.</p>
    </footer>

    <script>
        // --- API KEY DECLARATIONS ---
        // **IMPORTANT: For this to work on GitHub Pages, you MUST replace "" with your actual Gemini API key.**
        // WARNING: Exposing the key client-side is a security risk for a production app, but necessary for this single-file deployment.
        const API_KEY = ""; // <--- REPLACE THIS WITH YOUR GEMINI API KEY!
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        // VirusTotal Key (functional for Link verification)
        const VT_API_KEY = "89fbf8b690896870ef1fa81a19f6ac9d8bbe9563dc54d950fa34a64ceac33f97"; 
        
        // NumVerify Key (functional for Number verification)
        const NUMVERIFY_API_KEY = "1e8f0d3dce29513cc8db2e032bedc926"; 
        
        // --- VERIFIER FUNCTIONS ---

        // Helper function to render Markdown content from AI response
        function renderMarkdown(markdownText) {
            // Simplified markdown to HTML conversion
            let html = markdownText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italics
            
            // Convert list-like hyphens (which can be a new paragraph in a markdown block) to HTML lists
            let parts = html.split('\n').filter(p => p.trim() !== '');
            let inList = false;
            let finalHtml = '';

            parts.forEach(part => {
                if (part.startsWith('- ')) {
                    if (!inList) {
                        finalHtml += '<ul class="list-disc list-inside space-y-1 mt-1">';
                        inList = true;
                    }
                    finalHtml += `<li>${part.substring(2)}</li>`;
                } else {
                    if (inList) {
                        finalHtml += '</ul>';
                        inList = false;
                    }
                    finalHtml += `<p>${part}</p>`;
                }
            });
            if (inList) {
                finalHtml += '</ul>';
            }
            
            return finalHtml;
        }

        // News Verifier (Fixed to use client-side API call)
        async function checkFakeNewsAPI(claim) {
            if (!API_KEY) {
                 return {
                    status: 'verified_false', 
                    title: 'API KEY MISSING',
                    explanation: 'The Gemini API key is not set in the JavaScript code. Please replace the placeholder API_KEY with your actual key to enable this feature.',
                    advice: 'Find your Gemini API key and update the `API_KEY` constant in the script.',
                    source: 'Cyber Shell System',
                    sources: []
                };
            }

            const systemPrompt = `You are a world-class, objective fact-checking AI. Your task is to verify the factual correctness of the user's claim by using the provided Google Search results as your evidence. 
                Based ONLY on the search results, provide a final, short verdict (e.g., 'TRUE', 'FALSE', 'MISLEADING', or 'UNVERIFIABLE'). 
                Then, provide a brief (2-3 sentence) explanation of your finding and quote the strongest piece of evidence or contradiction from the search results.
                Format your entire response as markdown.`;
            
            const userQuery = `VERIFY THE ACCURACY OF THIS HEADLINE: "${claim}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ google_search: {} }],
                config: {
                    systemInstruction: systemPrompt
                }
            };

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     return {
                         status: 'inconclusive',
                         title: 'AI VERIFICATION FAILED',
                         explanation: `The AI service could not produce a definitive verdict. This could be due to a rate limit or an ambiguous query. Received error: ${result.error?.message || 'None'}`,
                         advice: 'Try simplifying the headline or check your API key quota.',
                         source: 'Gemini API', 
                         sources: []
                     };
                }

                const aiText = candidate.content.parts[0].text;
                
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                let status = 'inconclusive'; 
                const upperText = aiText.toUpperCase();

                if (upperText.includes('TRUE') || upperText.includes('CORRECT') && !upperText.includes('MOSTLY FALSE')) {
                    status = 'verified_true'; // Green/Safe
                } else if (upperText.includes('FALSE') || upperText.includes('INCORRECT') || upperText.includes('MISLEADING')) {
                    status = 'verified_false'; // Red/Danger
                } else if (upperText.includes('UNVERIFIABLE') || upperText.includes('INCONCLUSIVE')) {
                    status = 'inconclusive'; // Yellow/Warning
                }
                
                return {
                    status: status,
                    title: 'AI FACT-CHECK VERDICT',
                    explanation: aiText,
                    advice: 'Review the provided source links below before making a final judgment or sharing this information.',
                    source: 'Gemini 2.5 Flash',
                    sources: sources
                };

            } catch (e) {
                console.error("Gemini API Error:", e);
                return {
                     status: 'verified_false', 
                     title: 'VERIFICATION API CONNECTION ERROR',
                     explanation: `Failed to connect to the fact-checking service. This might be due to a rate limit, network issue, or invalid API key. Details: ${e.message}`,
                     advice: 'If this error persists, check your network connection and ensure your Gemini API key is correct.',
                     source: 'Cyber Shell System',
                     sources: []
                 };
            }
        }


        // Link Checker (Uses VirusTotal with new key + local checks)
        async function checkLinkAPI(url) {
            const isShortened = /(bit\.ly|tinyurl\.com|t\.co|goo\.gl|cutt\.ly|rebrand\.ly|is\.gd|s\.id|shorte\.st)/i.test(url);
            
            if (isShortened) {
                 return { 
                    status: 'inconclusive', 
                    title: 'URL SHORTENER DETECTED', 
                    explanation: 'The link uses a URL shortening service (like bit.ly or t.co), which hides the true destination. Exercise caution before clicking.', 
                    advice: 'Exercise extreme caution. Do not click unless you are absolutely sure of the source. Use a link expander service first.', 
                    source: 'Local Client Check' 
                };
            }
            
            let maliciousCount = 0;
            let reportSource = 'Local/Basic Check';

            if (VT_API_KEY) {
                try {
                    // VirusTotal Check
                    const urlToEncode = url.includes('://') ? url : `http://${url}`;
                    const vtUrlId = btoa(urlToEncode).replace(/\//g, '_').replace(/\+/g, '-').replace(/=/g, ''); 
                    
                    const vtRes = await fetch(`https://www.virustotal.com/api/v3/urls/${vtUrlId}`, { 
                        headers: { 'x-apikey': VT_API_KEY } 
                    });

                    if (vtRes.ok) {
                        const vtData = await vtRes.json();
                        if (vtData.data?.attributes?.last_analysis_stats) {
                           maliciousCount = vtData.data.attributes.last_analysis_stats.malicious || 0;
                           reportSource = 'VirusTotal API';
                        }
                    } else if (vtRes.status === 404) {
                        maliciousCount = 0;
                        reportSource = 'VirusTotal API (Unreported)';
                    } else {
                        // Handle rate limiting or other API errors
                        const errorData = await vtRes.json().catch(() => ({ error: { message: 'Unknown API error body.' } }));
                        reportSource = `VirusTotal API Error (${vtRes.status}): ${errorData.error?.message || 'Check key/quota.'}`;
                    }
                } catch (e) { 
                    console.error("VirusTotal Fetch Error:", e);
                    reportSource = 'VirusTotal API Connection Failed';
                }
            }

            if (maliciousCount > 0) {
                 return { 
                    status: 'verified_false', 
                    title: `MALICIOUS LINK DETECTED (${maliciousCount} Flags)`, 
                    explanation: `This URL has been flagged as malicious by **${maliciousCount} security vendors**. (${reportSource}).`, 
                    advice: '**DO NOT visit this link** under any circumstances. Block the sender immediately.', 
                    source: 'External Security Check' 
                };
            }

            // Check if the VT check failed or was inconclusive, but the URL looks non-standard/suspicious
            const isSuspiciousDomain = !/\./.test(url.split('/')[2]) || !url.includes('https');
            
            if (reportSource === 'VirusTotal API (Unreported)' && isSuspiciousDomain) {
                return { 
                    status: 'inconclusive', 
                    title: 'UNREPORTED AND UNSECURED URL', 
                    explanation: `This URL is not in the VirusTotal database, does not use HTTPS, or has an unusual domain structure.`, 
                    advice: 'Be extremely careful. Manually verify the domain name is correct and look for a lock icon next to the URL.', 
                    source: 'External Security/Local Check' 
                };
            }

            return { 
                status: 'verified_true', 
                title: 'URL APPEARS SAFE (No Threat Detected)', 
                explanation: `No malicious or known phishing activity was detected in the last scan. (${reportSource}).`, 
                advice: 'The link appears safe, but always be cautious of unexpected downloads or requests for personal data.', 
                source: 'External Security Check' 
            };
        }

        // Number Checker (Fully Functional with NumVerify API)
        async function checkNumberAPI(number) {
            const cleanedNumber = number.replace(/[\s\(\)-]/g, '');

            try {
                // NumVerify API requires access_key
                const response = await fetch(`https://apilayer.net/api/validate?access_key=${NUMVERIFY_API_KEY}&number=${cleanedNumber}`);
                const data = await response.json();
                
                if (data.success === false) {
                     return { 
                        status: 'inconclusive', 
                        title: 'VERIFICATION API ERROR', 
                        explanation: `The external number verification service returned an error. This may be due to a rate limit or an invalid API key.`, 
                        advice: 'This feature may be temporarily unavailable. Proceed with caution.', 
                        source: 'NumVerify API' 
                    };
                }

                if (data.valid === true) {
                    const isVoIP = data.line_type?.toLowerCase() === 'voip';
                    
                    if (isVoIP) {
                         return { 
                            status: 'inconclusive', 
                            title: 'VALID BUT HIGH-RISK (VOIP) NUMBER', 
                            explanation: `Valid number from ${data.country_name || 'an unknown region'}, but uses a **Voice over IP (VoIP)** line type. VoIP numbers are easily spoofed and commonly used for scams.`, 
                            advice: 'Treat calls from this number with **skepticism**. Be extremely wary of sharing personal information.', 
                            source: 'NumVerify API' 
                        };
                    }

                    return { 
                        status: 'verified_true', 
                        title: 'VALID & LOW-RISK NUMBER', 
                        explanation: `Valid phone number from **${data.country_name || 'an unknown region'}**, carrier: **${data.carrier || 'Unknown'}**, line type: **${data.line_type || 'Unknown'}**.`, 
                        advice: 'The number format is verified. However, always be cautious of unsolicited calls and never give out personal details.', 
                        source: 'NumVerify API' 
                    };

                } else {
                    return { 
                        status: 'verified_false', 
                        title: 'INVALID OR FAKE NUMBER', 
                        explanation: `This number is not a valid, recognized, or active telephone number in the country's system.`, 
                        advice: '**Do not answer or call back.** Block this number immediately as it is likely fraudulent/non-existent.', 
                        source: 'NumVerify API' 
                    };
                }

            } catch (e) {
                console.error("NumVerify Fetch Error:", e);
                return { 
                    status: 'verified_false', 
                    title: 'ANALYSIS FAILED', 
                    explanation: `Could not connect to the number verification service. Network error: ${e.message}`, 
                    advice: 'If unsure, it is safest not to interact with the number.', 
                    source: 'Cyber Shell System' 
                };
            }
        }
        
        // --- CORE APPLICATION LOGIC ---

        const verifiers = {
            news: {
                title: 'Fake News Verifier (AI Grounded)',
                placeholder: 'Enter a news headline or claim...',
                api: checkFakeNewsAPI,
                validation: (input) => input.split(' ').filter(word => word.length > 0).length >= 2 && input.length <= 500,
                errorMessage: 'Please enter a claim with at least 2 words (max 500 characters) for the AI check.'
            },
            link: {
                title: 'Phishing Link Checker',
                placeholder: 'Paste a suspicious URL (e.g., https://malicious.link)...',
                api: checkLinkAPI,
                // Less strict validation for live testing: allows anything that looks like a path or domain
                validation: (input) => input.length > 5 && (input.includes('.') || input.includes('/')),
                errorMessage: 'Please enter a valid-looking URL (must contain a dot or a slash and be over 5 characters).'
            },
            number: {
                title: 'Scam Number Checker',
                placeholder: 'Enter a phone number with country code (e.g., +15551234567)...',
                api: checkNumberAPI,
                validation: (input) => input.length > 7 && /^\+?[\d\s\(\)-]+$/.test(input),
                errorMessage: 'Please enter a valid phone number format (must be over 7 characters and contain digits, optionally starting with a +).'
            }
        };
        
        let activeVerifier = 'news';

        const verifierTabs = document.getElementById('verifier-tabs');
        const verifierTitle = document.getElementById('verifier-title');
        const verifierInput = document.getElementById('verifier-input');
        const verifierForm = document.getElementById('verifier-form');
        const verifyButton = document.getElementById('verify-button');
        const loader = document.getElementById('loader');
        const resultContainer = document.getElementById('result-container');
        const errorMessage = document.getElementById('error-message');

        // Utility function for exponential backoff retry logic (kept for robustness)
        async function fetchWithRetry(url, options, maxRetries = 5) {
             for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.status < 500) {
                        return response; // Success or non-retryable error
                    }
                    if (i === maxRetries - 1) {
                        throw new Error(`Max retries reached. Status: ${response.status}`);
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Rate limited (Status: ${response.status}). Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Fetch error. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Maximum fetch retries failed.");
        }
        
        // --- UI Event Handlers ---

        verifierTabs.addEventListener('click', (e) => {
            const button = e.target.closest('.verifier-tab');
            if (!button) return;
            activeVerifier = button.dataset.verifier;
            
            document.querySelectorAll('.verifier-tab').forEach(tab => {
                tab.classList.remove('bg-blue-600', 'text-white', 'shadow');
                tab.classList.add('text-gray-600', 'hover:bg-gray-200');
            });
            button.classList.add('bg-blue-600', 'text-white', 'shadow');
            button.classList.remove('text-gray-600', 'hover:bg-gray-200');

            verifierTitle.textContent = verifiers[activeVerifier].title;
            verifierInput.placeholder = verifiers[activeVerifier].placeholder;
            verifierInput.value = '';
            resultContainer.innerHTML = '';
            errorMessage.textContent = '';
            verifierInput.classList.remove('input-error');
        });

        verifierForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputValue = verifierInput.value.trim();
            resultContainer.innerHTML = '';
            errorMessage.textContent = '';
            verifierInput.classList.remove('input-error');

            const verifierConfig = verifiers[activeVerifier];
            
            // Input Validation
            if (!verifierConfig.validation(inputValue)) {
                errorMessage.textContent = verifierConfig.errorMessage;
                verifierInput.classList.add('input-error');
                return;
            }
            
            // Set Loading State
            loader.style.display = 'flex';
            verifyButton.disabled = true;
            verifyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin-slow h-5 w-5"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`;
            
            const result = await verifierConfig.api(inputValue);
            renderResultCard(result);

            // Restore Button State
            loader.style.display = 'none';
            verifyButton.disabled = false;
            verifyButton.textContent = 'Verify';
        });

        verifierInput.addEventListener('input', () => {
            if (errorMessage.textContent || verifierInput.classList.contains('input-error')) {
                errorMessage.textContent = '';
                verifierInput.classList.remove('input-error');
            }
        });

        function renderResultCard(result) {
            const styleConfigs = {
                safe: { icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8 text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`, classes: 'border-green-500 bg-green-50 text-green-800' },
                warning: { icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8 text-yellow-500"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>`, classes: 'border-yellow-500 bg-yellow-50 text-yellow-800' },
                danger: { icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8 text-red-500"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>`, classes: 'border-red-500 bg-red-50 text-red-800' }
            };

            // Map AI and other verification statuses to display styles
            const statusMap = {
                verified_true: 'safe',
                inconclusive: 'warning',
                verified_false: 'danger'
            };
            
            const resultStyle = statusMap[result.status] || 'warning';
            const config = styleConfigs[resultStyle];
            
            // Define the Source Line
            const sourceLine = result.source && result.source.length > 0 
                ? `<p class="mt-4 text-xs text-gray-500">Service: ${result.source}</p>`
                : '';

            // Check if the result includes AI sources (only for the 'news' verifier)
            let extraContent = '';
            if (activeVerifier === 'news') {
                 // For News, the explanation becomes the primary content 
                 const sourceHtml = result.sources.length > 0
                    ? result.sources.map(s => 
                        `<li class="truncate text-xs"><a href="${s.uri}" target="_blank" class="text-blue-600 hover:underline">${s.title}</a></li>`
                      ).join('')
                    : '<li class="text-xs text-gray-500">No specific public web sources cited by the AI.</li>';
                
                 extraContent = `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm font-semibold text-gray-800">Explanation & Evidence:</p>
                        <div class="mt-2 p-3 rounded-lg bg-white border border-gray-100 prose text-sm text-gray-700">
                            ${renderMarkdown(result.explanation)}
                        </div>
                        <p class="text-sm font-semibold text-gray-800 mt-4">Verification Sources (Google Search):</p>
                        <ul class="list-disc list-inside space-y-1 mt-1 pl-2 text-sm">
                            ${sourceHtml}
                        </ul>
                    </div>
                `;
            } else {
                 // Non-AI (link/number) explanation uses the standard explanation field
                 extraContent = `<p class="mt-2 text-sm text-gray-700">${result.explanation}</p>`;
            }

            const cardHTML = `
                <div class="mt-6 rounded-lg border-l-4 p-4 sm:p-6 shadow-md animate-fade-in ${config.classes}">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">${config.icon}</div>
                        <div class="ml-4 flex-1">
                            <p class="text-lg font-bold ${config.classes.split(' ')[2]}">${result.title}</p>
                            
                            ${extraContent}

                            <div class="mt-4">
                                <p class="text-sm font-semibold text-gray-800">User Advice:</p>
                                <p class="text-sm text-gray-600">${result.advice}</p>
                            </div>
                            ${sourceLine} 
                        </div>
                    </div>
                </div>
            `;
            resultContainer.innerHTML = cardHTML;
        }
        // Initialize the first tab state on page load
        document.addEventListener('DOMContentLoaded', () => {
            verifierTitle.textContent = verifiers['news'].title;
            verifierInput.placeholder = verifiers['news'].placeholder;
            // Ensure the initial tab is correctly styled
            const initialTab = document.querySelector('.verifier-tab[data-verifier="news"]');
            if (initialTab) initialTab.click();
        });
    </script>
</body>
</html>
